---
title: "Events"
subtitle: "Measures and Basic Tests"
author: "Frances Hung"
date: "10/6/2022"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message=FALSE)
library(tidyverse)
library(Gmisc)
library(Hmisc)
library(gtsummary)
library(epitools)
library(epiR)
library(medicaldata)
#library(flextable)
```

Today, we will go over common measures used to describe event occurrence in populations. This includes language for describing:

-   How often events occur (rates, incidence)
-   How many individuals in the population have experienced an event (proportion, prevalence)
-   How does a characteristic affects probability of experiencing an event (odds ratio, risk ratio)

This will come in handy later, when we have to interpret regression models. For simplicity, we'll concentrate only on whether or not an event occurs (yes/no). We may briefly mention models for how event rates change over time later (Poisson and negative binomial regression), but this is outside of the scope of this introductory class. 

After this, we will cover basic ways of comparing event rates and incidences between groups differentiated by a characteristic. Some of these concepts (t-tests, correlation) are also applicable to and important for understanding continuous data as well.

## Review: Data Cleaning and Visualization

Since today's lecture is focused on events, let's clean and visualize a dataset that we can use for the remainder of the lecture.

## Rates, Proportions, Incidence and prevalence

There are a few important measures scientists use to describe how often events occur and how widespread events are within a population.

**Rate** measures how fast disease is occurring in a population.

**Proportion** measures the fraction of population affected.

**Incidence** focuses on new cases occurring during a specific time period and helps us understand the risk and dynamics of disease occurrence. It is an specific example of rate.

Incidence rate over a defined time period = (Number of new cases) / (Population at risk)

**Prevalence** considers both new and existing cases at a particular point or over a specified period and provides insights into the overall burden of the disease in a population. It is a specific example of proportion.

Prevalence = (Number of existing cases) / (Total population)

The below sample is from the `epitools` package. Researchers conducted a case-control study assessing whether exposure to tap water is associated with crytosporidiosis among AIDs patients in San Francisco. There are three levels of tap water exposure. 

```{r tap-water, options}
tapw <- c("Lowest", "Intermediate", "Highest")
outc <- c("Case", "Control")	
dat <- matrix(c(2, 29, 35, 64, 12, 6),3,2,byrow=TRUE)
dimnames(dat) <- list("Tap water exposure" = tapw, "Outcome" = outc)
```

We can use `epi.prev` to calculate prevalence at each tap water exposure level with standard Wilson confidence intervals. The estimates are interpreted as outcomes per 100 patients.

```{r}
prevObj <- epi.prev(pos = dat[,"Case"], 
         tested = dat[,"Case"] + dat[,"Control"],
         se = c(1,1,1),
         sp = c(1,1,1),
         units = 100)

prevObj$ap
```

## Relative Risk and Odds Ratio

**Risk factor**: A characteristic which may increase the risk of an event.

**Relative Risk**: (Probability of an event among subjects with risk factor)/(Probability of an event among subjects without risk factor)

We can calculate the relative risk of a patient with highest tap water exposure getting crytosporadiosis compared to a patient with lowest tap water exposure.


```{r RR, options}
highest <- 18
highest.case <- 12
lowest <- 31
lowest.case <- 2

# calculating RR by hand
RR.case <- (highest.case/highest)/(lowest.case/lowest)


# for tap water highest vs. lowest exposure
epi.2by2(dat[c(3,1),], # reorganizing so first row is highest tap water exposure (risk factor)
         method = "cohort.count")
```

**Odds**: (Probability of experiencing event)/(Probability of not experiencing event)

**Odds Ratio**: (Odds of event among subjects with risk factor)/(Odds of event among subjects without risk factor)

```{r OR, options}
highest.odds <- highest.case/(highest-highest.case)
lowest.odds <- lowest.case/(lowest-lowest.case)

highest.odds/lowest.odds

# for tap water highest vs. lowest exposure
epi.2by2(dat[c(3,1),], # reorganizing so first row is highest tap water exposure (risk factor)
         method = "cohort.count")
```

### Exercises: Measures

TODO: from a tidy dataset, create the 2x2 table and calculate incidence, rate, RR and OR.

# Group comparisons of events

We can talk about basic ways of comparing event rates and proportions among different groups, now that we've defined what rates and proportions are. This is our first foray into statistical tests. This workshop is not meant to give statistical background on these tests, so stay tuned for the in-person workshop (or consult with a statistician) before using these tests in research projects.

Below are three different ways of visualizing or testing proportion differences among groups.

-   Correlation
-   2-proportion z-test
-   Chi-square

More sophisticated ways of testing event rate differences between groups (like logistic regression, adjusting for other variables) will be introduced later.

### Correlation

As discussed previously, correlation is a rough measure of how associated two variables are. The Pearson correlation we used previously for continuous variables makes the assumption of normality and linear relationship between variables, which does not apply for events (yes/no).

Instead, we must use either Spearman or Kendall's Tau.

### 2-proportion Z-Test (Parametric)

The 2-proportion z-test approximates how likely we'd see the observed difference in proportions, assuming that the true proportions of the groups are actually the same.

It assumes that if we took many samples from the two group populations, the resulting mean proportion would be normally distributed (bell-shaped). This usually holds if we have a large enough sample size.

### Chi-square (Non-parametric)

Like the 2-proportion z-test, the chi-squared test approximates how likely we'd see the observed difference in proportions, assuming that the true proportions of the groups are actually the same.

It doesn't have the same normality assumption as the z-test, making it good for small samples where the assumption may not hold.

```{r chisq, options}
#chi
```

# Sensivity, Specificity, ROC

One specialized application of categorical variables is analyzing the effectiveness of a diagnostic test for a disease. A clinical example would be analyzing HIV positivity in deceased people in Kenya with a rapid antigen/antibody test called OraQuick.

Key predictive measures include:

- sensitivity
- specificity
- PPV
- NPV
- LR+
- LR-

The `epi.tests` function returns point estimates and confidence intervals for all of the above measures.

```{r pred-vals, options}
true.pos <- 25
true.neg <- 102
false.neg <- 2
false.pos <- 3

epi.tests(dat = c(true.pos, false.pos, false.neg, true.neg),
          method = "wilson")
```

# Bibliography 
Opollo, Valarie PhDa; Nyakeriga, Emmanuel MScb; Kingwara, Leonard MScc; Sila, Alex BScb; Oguta, Macxine BSca; Oyaro, Boaz BSca; Onyango, Dickens MBChBd,e,f; Mboya, Frankline O. MScg; Waruru, Anthony PhDg; Musingila, Paul BScg; Mwangome, Mary MBChBb; Nyagah, Lilly M. MBChBc; Ngugi, Catherine MBChBc; Sava, Solomon MBChBc; Waruiru, Wanjiru MBChBb; Young, Peter W. MBChBg; Junghae, Muthoni PhDg. Evaluation of the Performance of OraQuick Rapid HIV-1/2 Test Among Decedents in Kisumu, Kenya. JAIDS Journal of Acquired Immune Deficiency Syndromes 89(3):p 282-287, March 1, 2022. | DOI: 10.1097/QAI.0000000000002857 